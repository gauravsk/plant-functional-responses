---
title: "ML estimates of demographic parameters"
author: "Gaurav Kandlikar"
date: "February 28, 2018"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up competition models
First we set up the models, as motived by JHRL.

### Model 1: No effect of competitors on seed production
```{r comp-model-1}
compmodel1 <- function(par) {
  mu = par[1] 
  sigma = par[2]
  pred = mu # The predicted seed output is just the mean
  llik = dnorm(lseed, log(pred), sd = sigma, log = TRUE)
  return(sum(-1*llik))
}
```

### Model 2: A global lambda, that decreases due to competition with neighbors
```{r comp-model-2}
# write a new model that has a global alpha and a global lambda
compmodel2<-function(par){
  lambda<-par[1]
  alpha<-par[2]
  sigma<-par[3]
  pred<-lambda/(1+alpha*(dens)) #this is the predictive model
  llik<-dnorm(lseed,log(pred), sd=sigma, log=TRUE) #these are the log likelihoods
  return(sum(-1*llik)) #sum of negative log likelihoods
}
```

### Model 3: Global alpha; Global lambda that gets modified by a site-specific coefficient
```{r comp-model-3}
# write a new model that has a global alpha and a global lambda that is additively modified by a site-term
compmodel3<-function(par){
  lambda <- par[1]
  alpha  <- par[2]
  sigma  <- par[3]
  site1  <- par[4]
  site2  <- par[5] 
  site3  <- par[6] 
  site4  <- par[7] 
  site5  <- par[8] 
  site6  <- par[9] 
  site7  <- par[10] 
  site8  <- par[11] 
  site9  <- par[12]
  site10 <- par[13] 
  site11 <- par[14] 
  site12 <- par[15] 
  site13 <- par[16] 
  site14 <- par[17] 
  site15 <- par[18] 
  site16 <- par[19] 
  site17 <- par[20] 
  site18 <- par[21] 
  site19 <- par[22] 
  site20 <- par[23] 
  site21 <- par[24] 
  site22 <- par[25] 
  site23 <- par[26] 
  site24 <- par[27] 
  pred<-(lambda + site1*site_matrix[, 1]+ site2*site_matrix[, 2] + site3*site_matrix[, 3] + site4*site_matrix[, 4] + site5*site_matrix[, 5] + site6*site_matrix[, 6] + site7*site_matrix[, 7] + site8*site_matrix[, 8] + site9*site_matrix[, 9] + site10*site_matrix[, 10] + site11*site_matrix[, 11] + site12*site_matrix[, 12] + site13*site_matrix[, 13] + site14*site_matrix[, 14] + site15*site_matrix[, 15] + site16*site_matrix[, 16] + site17*site_matrix[, 17] + site18*site_matrix[, 18] + site19*site_matrix[, 19] + site20*site_matrix[, 20] + site21*site_matrix[, 21] + site22*site_matrix[, 22] + site23*site_matrix[, 23] + site24*site_matrix[, 24])/(1+alpha*(dens)) #this is the predictive model
  llik<-dnorm(lseed,log(pred), sd=sigma, log=TRUE) #these are the log likelihoods
  return(sum(-1*llik)) #sum of negative log likelihoods
}
```

### Model 4: Global alpha; 24 site-specific lambda terms per species
```{r comp-model-4}
# write a new model that has a global alpha and 24 site-specific lambda terms per species
compmodel4<-function(par){
  alpha  <- par[1]
  sigma  <- par[2]
  site1  <- par[3]
  site2  <- par[4] 
  site3  <- par[5] 
  site4  <- par[6] 
  site5  <- par[7] 
  site6  <- par[8] 
  site7  <- par[9] 
  site8  <- par[10] 
  site9  <- par[11]
  site10 <- par[12] 
  site11 <- par[13] 
  site12 <- par[14] 
  site13 <- par[15] 
  site14 <- par[16] 
  site15 <- par[17] 
  site16 <- par[18] 
  site17 <- par[19] 
  site18 <- par[20] 
  site19 <- par[21] 
  site20 <- par[22] 
  site21 <- par[23] 
  site22 <- par[24] 
  site23 <- par[25] 
  site24 <- par[26] 
  pred<-(site1*site_matrix[, 1]+ site2*site_matrix[, 2] + site3*site_matrix[, 3] + site4*site_matrix[, 4] + site5*site_matrix[, 5] + site6*site_matrix[, 6] + site7*site_matrix[, 7] + site8*site_matrix[, 8] + site9*site_matrix[, 9] + site10*site_matrix[, 10] + site11*site_matrix[, 11] + site12*site_matrix[, 12] + site13*site_matrix[, 13] + site14*site_matrix[, 14] + site15*site_matrix[, 15] + site16*site_matrix[, 16] + site17*site_matrix[, 17] + site18*site_matrix[, 18] + site19*site_matrix[, 19] + site20*site_matrix[, 20] + site21*site_matrix[, 21] + site22*site_matrix[, 22] + site23*site_matrix[, 23] + site24*site_matrix[, 24])/(1+alpha*(dens)) #this is the predictive model
  llik<-dnorm(lseed,log(pred), sd=sigma, log=TRUE) #these are the log likelihoods
  return(sum(-1*llik)) #sum of negative log likelihoods
}


```


### Model 5: 24 site-specific lambda terms and 24 site-specific alpha terms per species
```{r comp-model-5}
compmodel5<-function(par){
  # The sigma is still global
  sigma  <- par[1, 1]

  # Site specific alphas ---------
  alpha1  <- par[2, 1]
  alpha2  <- par[3, 1] 
  alpha3  <- par[4, 1] 
  alpha4  <- par[5, 1] 
  alpha5  <- par[6, 1] 
  alpha6  <- par[7, 1] 
  alpha7  <- par[8, 1] 
  alpha8  <- par[9, 1] 
  alpha9  <- par[10, 1]
  alpha10 <- par[11, 1] 
  alpha11 <- par[12, 1] 
  alpha12 <- par[13, 1] 
  alpha13 <- par[14, 1] 
  alpha14 <- par[15, 1] 
  alpha15 <- par[16, 1] 
  alpha16 <- par[17, 1] 
  alpha17 <- par[18, 1] 
  alpha18 <- par[19, 1] 
  alpha19 <- par[20, 1] 
  alpha20 <- par[21, 1] 
  alpha21 <- par[22, 1] 
  alpha22 <- par[23, 1] 
  alpha23 <- par[24, 1] 
  alpha24 <- par[25, 1] 
  
  # Site specific lambas
  site1  <- par[2, 2]
  site2  <- par[3, 2] 
  site3  <- par[4, 2] 
  site4  <- par[5, 2] 
  site5  <- par[6, 2] 
  site6  <- par[7, 2] 
  site7  <- par[8, 2] 
  site8  <- par[9, 2] 
  site9  <- par[10, 2]
  site10 <- par[11, 2] 
  site11 <- par[12, 2] 
  site12 <- par[13, 2] 
  site13 <- par[14, 2] 
  site14 <- par[15, 2] 
  site15 <- par[16, 2] 
  site16 <- par[17, 2] 
  site17 <- par[18, 2] 
  site18 <- par[19, 2] 
  site19 <- par[20, 2] 
  site20 <- par[21, 2] 
  site21 <- par[22, 2] 
  site22 <- par[23, 2] 
  site23 <- par[24, 2] 
  site24 <- par[25, 2] 
  
  

  pred<-(site1*sites[, 1]+ site2*sites[, 2] + site3*sites[, 3] + site4*sites[, 4] + 
           site5*sites[, 5] + site6*sites[, 6] + site7*sites[, 7] + site8*sites[, 8] + 
           site9*sites[, 9] + site10*sites[, 10] + site11*sites[, 11] + site12*sites[, 12] + 
           site13*sites[, 13] + site14*sites[, 14] + site15*sites[, 15] + site16*sites[, 16] + 
           site17*sites[, 17] + site18*sites[, 18] + site19*sites[, 19] + site20*sites[, 20] + 
           site21*sites[, 21] + site22*sites[, 22] + site23*sites[, 23] + site24*sites[, 24]) /
    (1+ alpha1*compdens[, 1]+ alpha2*compdens[, 2] + alpha3*compdens[, 3] + alpha4*compdens[, 4] + 
       alpha5*compdens[, 5] + alpha6*compdens[, 6] + alpha7*compdens[, 7] + alpha8*compdens[, 8] + 
       alpha9*compdens[, 9] + alpha10*compdens[, 10] + alpha11*compdens[, 11] + alpha12*compdens[, 12] + 
       alpha13*compdens[, 13] + alpha14*compdens[, 14] + alpha15*compdens[, 15] + alpha16*compdens[, 16] + 
       alpha17*compdens[, 17] + alpha18*compdens[, 18] + alpha19*compdens[, 19] + alpha20*compdens[, 20] + 
       alpha21*compdens[, 21] + alpha22*compdens[, 22] + alpha23*compdens[, 23] + alpha24*compdens[, 24]) #this is the predictive model
  llik<-dnorm(lseed,log(pred), sd=sigma, log=TRUE) #these are the log likelihoods
  return(sum(-1*llik)) #sum of negative log likelihoods
}

```

## Read in data

```{r import-data}
library(dplyr)
compdens <- read.csv("~/Dropbox/spatial_tapioca/data/performance/calculated/NCompetitors_per_plot.csv")
seedprod <- read.csv("~/Dropbox/spatial_tapioca/data/performance/seed_production_processed.csv", stringsAsFactors = F)
# replace 0s with NAs...
seedprod[which(seedprod$num_seeds_produced == 0), "num_seeds_produced"] <- NA
# maybe switch to be the minimum for the species?
seedprod <- na.omit(seedprod)
seedprod$sp_code <- as.character(seedprod$sp_code)
seedprod$sp_code[which(seedprod$sp_code=="AGSP")] <- "AGHE"
seedprod$sp_code[which(seedprod$sp_code=="CEMI")] <- "CEME"
seedprod$sp_code[which(seedprod$sp_code=="VUMI")] <- "VUMA"

compdens <- dplyr::select(compdens, -N_per_compPlot)
compdens$N_per_neighborhood <- floor(compdens$N_per_neighborhood)
seedprod <- left_join(seedprod, compdens)
# Reset the competitor density in Lambda plots to 0
seedprod[which(seedprod$plot_type == "L"), "N_per_neighborhood"] <- 0

seedprod <- seedprod %>% mutate(num_seeds_produced = as.integer(num_seeds_produced),
                    N_per_neighborhood = as.integer(N_per_neighborhood))


# Fit the four models to just AGHE right now
# Later we loop over all the species in the dataset
sp = "AGHE"

lseed <- seedprod %>% filter(sp_code == sp) %>% dplyr::select(num_seeds_produced) %>% log %>% unlist %>% as.numeric
dens <- seedprod %>% filter(sp_code == sp) %>% dplyr::select(N_per_neighborhood) %>% unlist %>% as.numeric
which_plot <- seedprod %>% filter(sp_code == sp) %>% dplyr::select(plot_num)
which_plot <- which_plot$plot_num
plot_yesno <- table(which_plot)

# Make a site matrix
site_matrix <- seedprod %>% filter(sp_code == sp) %>% 
  mutate(which = row_number(), yesno = 1) %>% 
  distinct %>% tidyr::spread(plot_num,yesno, fill  = 0) %>% 
  arrange(which) %>% select(-c(plot_type,replicate,sp_code,num_seeds_produced,N_per_neighborhood, which)) %>% as.matrix

# If there's fewer than 4 measured plants at a site, set it to zero later.
set_to_na <- as.vector(which(colSums(site_matrix) < 4))

# Set the mean and SD of lseed as the starting points for the first optimization

par = c(mean(lseed), sd(lseed))
cat("Mean and SD for species:\n"); par
for(i in 1:25){testcomp1<-optim(par,compmodel1); par<-testcomp1$par; if(testcomp1$convergence==0){break}}
print(paste(sp, ": Model 1 converged on rep", i))
cat("Mean and SD estimates after model 1:\n"); par

# Set mean and SD from model 1, and alpha as 0.001 to run model 2
par<-c(testcomp1$par[1],0.001,testcomp1$par[2]) #for model 2, start with reasonable starting values
for(i in 1:25){testcomp2<-optim(par,compmodel2); par<-testcomp2$par; if(testcomp2$convergence==0){break}}
print(paste(sp, ": Model 2 converged on rep", i))
cat("Mean Lambda, Alpha, and SD estimates after model 2:\n"); par

par <- c(testcomp2$par[1],testcomp2$par[2], testcomp2$par[3], rep(0.01, 24))
for(i in 1:50){testcomp3<-optim(par,compmodel3,  method="L-BFGS-B", lower=c(1,0,0.000001, rep(0, 24))); par<-testcomp3$par; if(testcomp3$convergence==0){break}}
print(paste(sp, ": Model 3 converged on rep", i))
par  
testcomp3$par[set_to_na+3] <- 0


par <- c(testcomp2$par[2], testcomp2$par[3], rep(testcomp2$par[1], 24))
for(i in 1:50){testcomp4<-optim(par,compmodel4,  method="L-BFGS-B", lower=c(0,0.0000000001, c(rep(1,24)))); par<-testcomp4$par; if(testcomp4$convergence==0){break}}
print(paste(sp, ": Model 4 converged on rep", i))
testcomp4$par[set_to_na+2] <- 0

par <- cbind(c(testcomp4$par[2], rep(testcomp4$par[1], 24)), 
             c(NA, testcomp4$par[3:26]))
# This isn't working
for(i in 1:50){testcomp5<-optim(par,compmodel5,  method="L-BFGS-B", lower=c(0.0000000001,0.0000000001, c(rep(1,24)))); 
par<-testcomp5$par; if(testcomp5$convergence==0){break}}


  sigma  <- par[1, 1]

  # Site specific alphas ---------
  alpha1  <- par[2, 1]
  alpha2  <- par[3, 1] 
  alpha3  <- par[4, 1] 
  alpha4  <- par[5, 1] 
  alpha5  <- par[6, 1] 
  alpha6  <- par[7, 1] 
  alpha7  <- par[8, 1] 
  alpha8  <- par[9, 1] 
  alpha9  <- par[10, 1]
  alpha10 <- par[11, 1] 
  alpha11 <- par[12, 1] 
  alpha12 <- par[13, 1] 
  alpha13 <- par[14, 1] 
  alpha14 <- par[15, 1] 
  alpha15 <- par[16, 1] 
  alpha16 <- par[17, 1] 
  alpha17 <- par[18, 1] 
  alpha18 <- par[19, 1] 
  alpha19 <- par[20, 1] 
  alpha20 <- par[21, 1] 
  alpha21 <- par[22, 1] 
  alpha22 <- par[23, 1] 
  alpha23 <- par[24, 1] 
  alpha24 <- par[25, 1] 
  
  # Site specific lambas
  site1  <- par[2, 2]
  site2  <- par[3, 2] 
  site3  <- par[4, 2] 
  site4  <- par[5, 2] 
  site5  <- par[6, 2] 
  site6  <- par[7, 2] 
  site7  <- par[8, 2] 
  site8  <- par[9, 2] 
  site9  <- par[10, 2]
  site10 <- par[11, 2] 
  site11 <- par[12, 2] 
  site12 <- par[13, 2] 
  site13 <- par[14, 2] 
  site14 <- par[15, 2] 
  site15 <- par[16, 2] 
  site16 <- par[17, 2] 
  site17 <- par[18, 2] 
  site18 <- par[19, 2] 
  site19 <- par[20, 2] 
  site20 <- par[21, 2] 
  site21 <- par[22, 2] 
  site22 <- par[23, 2] 
  site23 <- par[24, 2] 
  site24 <- par[25, 2] 
  


```